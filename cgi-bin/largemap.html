#!/usr/bin/python

########################################################################
# Copyright 2015 Daniel Haake
#
# This file is part of lokiNET
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
########################################################################

import datetime
import sqlite3
import cgi


arguments = cgi.FieldStorage()
try:
        search = cgi.escape(arguments["search"].value)
except:
        search = ""

# get signature
f = open('webfiles/config')
dataFile = f.readlines()[0] + "Data.db"
f.close() 

# connect to local database file
connection = sqlite3.connect("data/" + dataFile)
connectionCursor = connection.cursor()

statement = "select distinct bssid from accesspoints"
connectionCursor.execute(statement)
allMacsAPs = connectionCursor.fetchall()

statement = "select distinct essid from accesspoints"
connectionCursor.execute(statement)
allEssidsAPs = connectionCursor.fetchall()

statement = "select distinct clientMac from clientProbes"
connectionCursor.execute(statement)
allMacsCPs = connectionCursor.fetchall()

statement = "select distinct probe from clientProbes"
connectionCursor.execute(statement)
allProbes = connectionCursor.fetchall()

connectionMACs = set()
statement = "select distinct macOne from connections"
connectionCursor.execute(statement)
macConnectionOne = connectionCursor.fetchall()
statement = "select distinct macTwo from connections"
connectionCursor.execute(statement)
macConnectionTwo = connectionCursor.fetchall()
for row in macConnectionOne:
        connectionMACs.add(row[0])
for row in macConnectionTwo:
        connectionMACs.add(row[0])

# HTTP header
print "Content-Type: text/html"
print ""

print "<!DOCTYPE html>"
print "<html>"

print "<head>"
print "<title>lokiNET (large map)</title>"
print "<link rel=\"stylesheet\" href=\"//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css\">"
print "<link rel=\"stylesheet\" type=\"text/css\" href=\"../webfiles/style.css\">"
print "<script src=\"//code.jquery.com/jquery-1.10.2.js\"></script>"
print "<script src=\"//code.jquery.com/ui/1.11.3/jquery-ui.js\"></script>"
print "<script>"
print "$.widget( \"custom.catcomplete\", $.ui.autocomplete, {"
print "_create: function() {"
print "this._super();"
print "this.widget().menu( \"option\", \"items\", \"> :not(.ui-autocomplete-category)\" );"
print "},"
print "_renderMenu: function( ul, items ) {"
print "var that = this,"
print "currentCategory = \"\";"
print "$.each( items, function( index, item ) {"
print "var li;"
print "if ( item.category != currentCategory ) {"
print "ul.append( \"<li class='ui-autocomplete-category'>\" + item.category + \"</li>\" );"
print "currentCategory = item.category;"
print "}"
print "li = that._renderItemData( ul, item );"
print "if ( item.category ) {"
print "li.attr( \"aria-label\", item.category + \" : \" + item.label );"
print "}"
print "});"
print "}"
print "});"
print "$(function() {"
print "var data = ["
for row in allMacsAPs:
        print "{ label: \"" + str(row[0]) + "\", category: \"BSSID\" },"
for row in allEssidsAPs:
        try:
                print "{ label: \"" + str(row[0]) + "\", category: \"ESSID\" },"
        except:
                # CRITICAL!!!!
                #
                print "{ label: \"!!! ASCII ERROR !!! \", category: \"ESSID\" },"
                #
for row in allMacsCPs:
        print "{ label: \"" + str(row[0]) + "\", category: \"client MAC\" },"
for row in connectionMACs:
        print "{ label: \"" + str(row) + "\", category: \"connection MAC\" },"
for row in allProbes:
        try:
                print "{ label: \"" + str(row[0]) + "\", category: \"client probes\" },"
        except:
                # CRITICAL!!!!
                #
                print "{ label: \"!!! ASCII ERROR !!! \", category: \"client probes\" },"
                #
print "];"
print "$( \"#search\" ).catcomplete({"
print "delay: 0,"
print "source: data"
print "});"
print "$( document ).tooltip({"
print "track: true"
print "});"
print "$( \"#dialog-confirm\" ).dialog({"
print "resizable: false,"
print "height:250,"
print "modal: true,"
print "buttons: {"
print "\"resolve now\": function() {"
print "$( this ).dialog( \"close\" );"
print "window.location.href='control.html?operation=1'"
print "},"
print "cancel: function() {"
print "$( this ).dialog( \"close\" );"
print "}"
print "}"
print "});"
print "});";
print "</script>"
print "<style>"
print ".ui-autocomplete-category {"
print "font-weight: bold;"
print "padding: .2em .4em;"
print "margin: .8em 0 .2em;"
print "font-size: 14px;"
print "line-height: 1.5;"
print "}"
print "</style>"
print "</head>"
print "<body id=\"bodyLogin\">"
oneValueIsZero = 0
statement = "select country, zipcode, city, street, streetnumber, ID from locations where gpsl = 0 or gpsw = 0"
connectionCursor.execute(statement)
allNeededLocations = connectionCursor.fetchall()
if len(allNeededLocations) != 0:
        print "<div id=\"dialog-confirm\" title=\"GPS error!\">"
        print "<p><span class=\"ui-icon ui-icon-alert\" style=\"float:left; margin:0 7px 20px 0;\"></span><div id=\"fontDiv\">There are locations where the address was not translated into GPS coordinates.</div></p>"
        print "</div>"
print "<table border=\"0\" id=\"creationTable\" style=\"left: 20%;	top: 5%;\">"
print "<tr><td height=\"20%\"><img src=\"../webfiles/logo.png\" width=\"50%\"></td></tr>"
print "<tr>"
print "<td>"
print "<table border=\"0\" width=\"350px\" style=\"background: #d3d3d3; border-radius: 5px;\">"
print "<tr><form method=\"get\"><td><input style=\"display: block;\" name=\"search\" class=\"input\" value=\"" + search + "\" id=\"search\" placeholder=\"search\"></td><td><input style=\"display: block; width: 100px;\" id=\"refButton\" type=\"submit\" value=\"search\"></td></form></tr>"
print "<tr><td colspan=\"2\">"

# include map header
print "<script src=\"http://maps.google.com/maps/api/js?sensor=false\" type=\"text/javascript\"></script>"
print "<div id=\"map\" style=\"width: 1024px; height: 550px;\"></div>"

if search != "":
        locationSet = set()
        statement = "select locationId from accesspoints where bssid=\"" + search + "\" or essid=\"" + search + "\""
        connectionCursor.execute(statement)
        locations = connectionCursor.fetchall()
        for i in locations:
                locationSet.add(i[0])
        statement = "select locationID from connections where macOne=\"" + search + "\" or macTwo=\"" + search + "\""
        connectionCursor.execute(statement)
        locations = connectionCursor.fetchall()
        for i in locations:
                locationSet.add(i[0])
        statement = "select locationId from clientProbes where clientMac=\"" + search + "\" or probe=\"" + search + "\""
        connectionCursor.execute(statement)
        locations = connectionCursor.fetchall()
        for i in locations:
                locationSet.add(i[0])
        # build where clause
        whereString = ""
        for item in locationSet:
                if whereString == "":
                        whereString += "ID=\"" + str(item) + "\""
                else:
                        whereString += " or ID=\"" + str(item) + "\""
        statement = "select country, zipcode, city, street, streetnumber, gpsl, gpsw, time from locations where " + whereString
        connectionCursor.execute(statement)
        resultAllLocations = connectionCursor.fetchall()
else:
        # get all the locations from database
        statement = "select country, zipcode, city, street, streetnumber, gpsl, gpsw, time from locations"
        connectionCursor.execute(statement)
        resultAllLocations = connectionCursor.fetchall()

details = []
count = 0
# get location details
for loc in range(1, len(resultAllLocations) + 1):
        statement = "select ID from accesspoints where locationID=\"" + str(loc) + "\""
        connectionCursor.execute(statement)        
        numAPs = connectionCursor.fetchall()
        statement = "select ID from clientProbes where locationID=\"" + str(loc) + "\""
        connectionCursor.execute(statement)        
        numProbes = connectionCursor.fetchall()        
        statement = "select ID from connections where locationID=\"" + str(loc) + "\""
        connectionCursor.execute(statement)        
        numConnections = connectionCursor.fetchall()        
        details.insert(count, "<p>Access Points: " + str(len(numAPs)) + "<br>Probes: " + str(len(numProbes)) + "<br>Connections: " + str(len(numConnections)))
        count += 1
        
locString = "<script type=\"text/javascript\">\nvar locations = [\n"
run = 1
l = 0
w = 0
for tupel in resultAllLocations:
        locString += "['" + tupel[0] + "<br>" + tupel[1] + ", <b>" + tupel[2] + "</b><br>" + tupel[3] + " " + tupel[4] + "<br><b>" + datetime.datetime.fromtimestamp(float(tupel[7])).strftime("%Y-%m-%d %H:%M:%S") + "</b>" + details[run-1] + "' ," + tupel[6] + ", " + tupel[5] + ", " + str(run) + "],\n"
        run += 1
        l += float(tupel[5])
        w += float(tupel[6])
locString = locString[:len(locString)-2:]
locString += "\n];"
middlePositionL = l / (run - 1)
middlePositionW = w / (run - 1)
print locString

print "var map = new google.maps.Map(document.getElementById('map'), {"
print "  zoom: 10,"
print "  center: new google.maps.LatLng(" + str(middlePositionW) + ", " + str(middlePositionL) + "),"
print "  mapTypeId: google.maps.MapTypeId.ROADMAP"
print "});"
print "var infowindow = new google.maps.InfoWindow();"
print "var marker, i;"
print "for (i = 0; i < locations.length; i++) {"
print "  marker = new google.maps.Marker({"
print "    position: new google.maps.LatLng(locations[i][1], locations[i][2]),"
print "    map: map"
print "  });"
print "  google.maps.event.addListener(marker, 'click', (function(marker, i) {"
print "    return function() {"
print "      infowindow.setContent(locations[i][0]);"
print "      infowindow.open(map, marker);"
print "    }"
print "  })(marker, i));"
print "}"
print "</script>"

print "</td></tr>"
print "<tr><td width=\"20%\"><input style=\"display: block; width: 100%;\" id=\"loginButton\" onclick=\"window.location.href='menu.html'\" type=\"button\" value=\"back\"></td><td></td></tr>"
print "</table>"
print "</body>"
print "</html>"
